<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ginga: Architecture and Internal API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ginga
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">The Ginga iTV middleware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('intapi.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Architecture and Internal API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md6"></a>
Architecture</h1>
<p>The external API of libginga consists of the abstract class <a class="el" href="classGinga.html" title="Ginga handle.">Ginga</a>. Internally, the functionality exposed by the <a class="el" href="classGinga.html" title="Ginga handle.">Ginga</a> class is implemented by the class Formatter. Along with Formatter, the other main components of libginga's internal API are the classes Parser and Document. The diagram below depicts the flow of information between the external world and the three main classes of libginga's internal API.</p>
<div class="image">
<img src="dia-architecture.png" alt=""/>
</div>
<p>The Formatter controls the life-cycle of the presentation. When it receives a <em>start</em> (<a class="el" href="classGinga.html#a3b3731f4fe3d22156205c6f2525da0cd" title="Starts the presentation of an NCL file.">Ginga::start</a>), it creates and uses a Parser to obtain a Document from the given NCL file. After the Document is obtained, the Parser is no longer needed and it is destroyed by the Formatter. (The Parser exists only during this brief moment; that is why it is drawn with dashed lines in the above diagram).</p>
<p>The Document contains the NCL object tree derived from the NCL file. This tree holds the state of the current NCL presentation. Before returning from the <em>start</em> call, the Formatter bootstraps the presentation by starting the root (Context) of the object tree. This action propagates through the object tree possibly triggering further actions and changing the state of the Document as a whole. We call the process of evaluating an action over the Document a <em>reaction</em>. In libginga, reactions are non-blocking and always terminate.</p>
<p>After the <em>start</em> call returns, the Formatter is driven by the caller, that is, the program using the external API.</p>
<ul>
<li>When the Formatter receives a <em>key</em> (<a class="el" href="classGinga.html#afc7a744785bbba1833dff2c98cce3b0e" title="Sends key event to presentation.">Ginga::sendKey</a>) it delivers it to all objects in the Document.</li>
<li>When the Formatter receives a <em>tick</em> (<a class="el" href="classGinga.html#a0020c15c05ed7e099c69b717354bdc2f" title="Sends tick event to presentation.">Ginga::sendTick</a>) it advances the time of all objects in the Document. This is the only place in which time advances, and it does so in lockstep: two objects that have been started in the same tick will always be synchronized.</li>
<li>When the Formatter receives a <em>redraw</em> request (<a class="el" href="classGinga.html#a23077db645f97e94e23e135b6f7539e7" title="Draws the latest frame of the presentation on Cairo context.">Ginga::redraw</a>) it renders and draws the frame corresponding to the current Document state in the given Cairo context.</li>
<li>When the Formatter receives a <em>state</em> request (<a class="el" href="classGinga.html#a7f004921deb3d254246c55f5efa1f094" title="Gets Ginga object state.">Ginga::getState</a>) it checks if the Document is still running and send this information back to the caller.</li>
<li>Finally, when the formatter receives a <em>stop</em> request (<a class="el" href="classGinga.html#a9e6656e6b426a002c9e666d573ed904c" title="Stops the presentation.">Ginga::stop</a>) it stops the presentation and destroys the Document.</li>
</ul>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>Errors in the input NCL file may lead to feedback loops in action propagation and, consequently, to endless reactions. If this happens and if the program has only one thread, which is usually the case, the program will enter an infinite loop.</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>Libginga handles audio output internally by itself. One cannot use the external API to get the audio samples corresponding to the current Document state.</dd></dl>
<h1><a class="anchor" id="autotoc_md7"></a>
Internal API</h1>
<h2><a class="anchor" id="autotoc_md8"></a>
%Document and Objects</h2>
<p>The Document contains the object tree of the NCL presentation and act as a high-level interface to this tree. It has methods to query the tree contents and to evaluate NCL actions over it, but not to change the tree contents or its structure.</p>
<p>The next diagram depicts the class hierarchy of the objects that can occur in the Document's object tree.</p>
<div class="image">
<img src="dia-objects.png" alt=""/>
</div>
<p>The classes Object and Composition are abstract. The concrete classes Media, MediaSettings, Context, and Switch stand for the corresponding elements in the NCL language:</p>
<ul>
<li>A Media represents a &lt;media&gt; element in the NCL document.</li>
<li>A MediaSettings represents the settings &lt;media&gt; element. There is exactly one settings object per Document. (Although the document may contain multiple settings &lt;media&gt; elements, all of them represent the same object.)</li>
<li>Context represents a &lt;context&gt; element.</li>
<li>Switch represents a &lt;switch&gt; element.</li>
</ul>
<p>Every Object has an <em>id</em> which must be unique within the Document. Objects can also have aliases which are collected and installed by the Parser. The id of the root object is always "__root__" and the id of the settings object is always "__settings__".</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Events</h2>
<p>Every Object has a set of events, class Event, each representing an event state machine of NCL. Events are <em>not</em> first-class citizens. They exist within exactly one Object and are owned by it.</p>
<p>There are three types of events (Event::Type):</p>
<ol type="1">
<li>Event::PRESENTATION: Represents the presentation of a particular time interval of its object. Every object has at least one presentation event, called <em>lambda</em>, which represents the presentation of the object itself. Besides the lambda presentation event, which is created by default for every object, the Parser creates a presentation event every time it encounters an &lt;area&gt; element. The container Object in this case is the object corresponding to the parent &lt;media&gt; element.</li>
<li>Event::ATTRIBUTION: Represents the attribution of some value to a particular property of its object. The Parser creates an attribution event every time it encounters a &lt;property&gt; element. The container Object in this case is the object corresponding to the parent &lt;media&gt; or &lt;property&gt; elements.</li>
<li>Event::SELECTION: Represents the selection of the container object via a particular key. The Parser creates a selection event every time it encounters a link &lt;bind&gt; with role "onSelection" or "onKeySelection". The container Object in this case is the object referenced by the &lt;bind&gt; element.</li>
</ol>
<p>Independently of its type, every Event maintains a state machine with three states, namely, Event::OCCURRING, Event::PAUSED, and Event::SLEEPING (the initial state), and labeled transitions between these states. The possible state transitions and their labels (Event::Transition) are listed in the table below.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">From   </th><th class="markdownTableHeadNone">To   </th><th class="markdownTableHeadNone">Transition (label)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Event::SLEEPING   </td><td class="markdownTableBodyNone">Event::OCCURRING   </td><td class="markdownTableBodyNone">Event::START    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Event::OCCURRING   </td><td class="markdownTableBodyNone">Event::SLEEPING   </td><td class="markdownTableBodyNone">Event::STOP or Event::ABORT    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Event::PAUSED   </td><td class="markdownTableBodyNone">Event::OCCURRING   </td><td class="markdownTableBodyNone">Event::START or Event::RESUME    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Event::OCCURRING   </td><td class="markdownTableBodyNone">Event::PAUSED   </td><td class="markdownTableBodyNone">Event::PAUSE    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Event::PAUSED   </td><td class="markdownTableBodyNone">Event::SLEEPING   </td><td class="markdownTableBodyNone">Event::STOP or Event::ABORT   </td></tr>
</table>
<p>The method Event::transition transitions an Event. When transitioning, the Event notify its container Object, via Object::beforeTransition and Object::afterTransition, which can act accordingly. For instance, the start transition of the lambda event of a Context should cause the Context to schedule the start of events referenced by its ports in the next tick.</p>
<p>Although a call to Event::transition may lead to further implicit transitions, Event::transition calls by themselves do not do not trigger links. What trigger links in libginga are actions. Actions and links are discussed in the next section. But before that there is one last thing we have to say about events: how libginga references them in logs.</p>
<p>Every Event has an id which must be unique within its Object. Libginga adopts a specific format when creating an pretty-printing event ids. This format is detailed in the table below.</p>
<table class="doxtable">
<tr>
<th>ID Pretty-Printing Format </th><th>Type </th><th>Description  </th></tr>
<tr>
<td><code>obj@area</code> </td><td>Event::PRESENTATION </td><td><em>obj</em> is the id of the container Object and <em>area</em> is the id of the corresponding &lt;area&gt; element. If this event has no corresponding &lt;area&gt; element, then <code>evt</code> is the lambda event and its id is the string "lambda".  </td></tr>
<tr>
<td><code>obj.name</code> </td><td>Event::ATTRIBUTION </td><td><em>obj</em> is the id of the container object and <em>name</em> is the name of the corresponding &lt;property&gt; element.  </td></tr>
<tr>
<td><code>obj&lt;key&gt;</code> </td><td>Event::SELECTION </td><td><em>obj</em> is the id of the container object and <em>key</em> is the name of the key expected by the corresponding &lt;bind&gt; element.  </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md10"></a>
Actions and Links</h2>
<p>An Action is a structure that associates an Event to a desired Event::Transition. One evaluates an Action over a Document using Document::evalAction. This method applies the desired transition over the event and, if the transition is successfully executed, triggers any links that are waiting for it, initiating a chain reaction.</p>
<p>In libginga, links is are stored in a list in the Context object (member Context::_links). Each link is a pair. The first member of the pair, called the link <em>head</em>, is the list of actions whose execution should cause the link to trigger. The second member of the pair, called the link <em>tail</em>, is the sequence of actions that should be evaluated over the document when the link is triggered.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Players</h2>
<p>Each Media maintains a single Player. This Player is created when the Media's lambda event is started, and it is destroyed as soon as the Media's lambda event is stopped.</p>
<div class="image">
<img src="dia-players.png" alt=""/>
</div>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
